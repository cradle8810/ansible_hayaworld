---
- name: "Make logs mountpoint"
  ansible.builtin.file:
    path: "{{ rsyslog_server_mountpoint }}"
    state: directory
    owner: syslog
    group: adm
    mode: '0755'

- name: "Mount drive"
  ansible.posix.mount:
    src: "UUID={{ rsyslog_server_uuid }}"
    path: "{{ rsyslog_server_mountpoint }}"
    fstype: "{{ rsyslog_server_fstype }}"
    opts: "{{ rsyslog_server_options }}"
    state: mounted

- name: "Install rsyslog"
  ansible.builtin.apt:
    pkg: rsyslog
    cache_valid_time: "{{ all.vars.apt.cache_valid_time }}"
  notify: "Restart rsyslog"

- name: "Make Config directory"
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop:
    - path: "/etc/rsyslog.d"
      owner: syslog
      group: adm
    - path: "/etc/logrotate.d"
      owner: root
      group: root

- name: "Remove default config"
  ansible.builtin.file:
    path: "/etc/rsyslog.d/50-default.conf"
    state: absent

- name: "Install rsyslog Config"
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: '0644'
  loop:
    - src: templates/etc/rsyslog.d/10-hayaworld.conf.j2
      dest: /etc/rsyslog.d/10-hayaworld.conf
      owner: syslog
      group: adm
    - src: templates/etc/rsyslog.conf.j2
      dest: /etc/rsyslog.conf
      owner: syslog
      group: adm
    - src: templates/etc/logrotate.d/10-hayaworld.j2
      dest: /etc/logrotate.d/10-hayaworld
      owner: root
      group: root
  notify:
    - "Restart rsyslog"
    - "Restart logrotate"
