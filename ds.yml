---
- name: Play for NextCloud
  hosts: ds
  remote_user: root
  gather_facts: true
  become: true

  vars_files:
    - host_vars/networks.yml

  handlers:
    - name: Restart handler tasks
      ansible.builtin.import_tasks:
        file: handlers/main.yml

  tasks:
    - name: Common Settings
      ansible.builtin.import_role:
        name: common
      vars:
        common_firewall: "{{ firewall }}"
        common_pkg: "{{ apt }}"
        common_install_users: false

    - name: Add user for nextcloud execution
      ansible.builtin.user:
        name: "www-data"
        shell: /bin/false
        uid: 33
        group: "www-data"
        append: true
        expires: -1
        password: '!'

    - name: Install Docker
      ansible.builtin.import_tasks:
        file: tasks/runner/install_docker.yml
      vars:
        hostname: "{{ common_hostinfo.shortname }}"
      tags:
        - runners
        - docker

    - name: "Install and Configure NextCloud"
      tags:
        - nextcloud
      block:
        - name: "Make directory to mount up skylark"
          ansible.builtin.file:
            path: "{{ nextcloud.nfs.dest }}"
            state: directory
            owner: www-data
            group: www-data
            mode: '0755'

        - name: "Mount up skylark"
          ansible.posix.mount:
            src: "{{ nextcloud.nfs.src }}"
            path: "{{ nextcloud.nfs.dest }}"
            opts: "defaults"
            fstype: nfs4
            state: mounted

        - name: "Initialize Directories (NextCloud)"
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            owner: www-data
            group: www-data
            mode: '0750'
          loop: 
            - "{{ nextcloud.dest.data }}"
            - "{{ nextcloud.dest.config }}"
            - "{{ nextcloud.dest.db }}"
            - "/root/ds/"

        - name: "Initialize Directories (MySQL)"
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            owner: 999
            group: 999
            mode: '0750'
          loop: 
            - "{{ nextcloud.dest.db }}"

        - name: "Put docker-compose.yml"
          ansible.builtin.template:
            src: templates/ds/root/ds/docker-compose.yml.j2
            dest: /root/ds/docker-compose.yml
            owner: root
            group: root
            mode: '0644'

        - name: "Start NextCloud Docker Compose"
          community.docker.docker_compose_v2:
            project_src: /root/ds/
            state: present

    - name: APC UPS Settings
      ansible.builtin.import_role:
        name: apcupsd
      vars:
        apcupsd_role: "slave"
        apcupsd_timeout: 60
      tags:
        - apc
        - ups

    - name: "Configure Rsyslog"
      ansible.builtin.import_role:
        name: rsyslog_client
      vars:
        rsyslog_client_additional_actions: "{{ rsyslog.rsyslog_client_additional_actions }}"
        rsyslog_client_journald_persistent: false
      tags:
        - rsyslog
