---
rui_info: "{{ network | selectattr('shortname', 'eq', 'rui') | first }}"
mai_info: "{{ network | selectattr('shortname', 'eq', 'mai') | first }}"

dnsmasq:
  domain: hayaworld.home
  local: /hayaworld.home/
  listen_address: "{{ rui_info.ipv4 }}"
  interface: "{{ rui_info.interface }}"
  dns:
    cache_size: 4000
    NXDOMAIN_hosts: /etc/dnsmasq.d/NXDOMAIN.conf
  logs:
    log_facility: local5
    log_to: "log.hayaworld.home"
  ipv6:
    dns6_server_self: "{{ rui_info.ipv6_addr }}"
    dns6_server_other: "{{ mai_info.ipv6_addr }}"
  ipv4:
    dns4_server_self: "{{ rui_info.ipv4 }}"
    dns4_server_other: "{{ mai_info.ipv4 }}"

dhcp:
  interface: "{{ mai_info.interface }}"
  me: "rui"
  peer:
    - name: "mai"
      url: "http://{{ mai_info.ipv4 }}:8080/"
      role: "primary"
      auto-failover: true
    - name: "rui"
      url: "http://{{ rui_info.ipv4 }}:8080/"
      role: "standby"
      auto-failover: true
  ipv4:
    subnet: "192.168.1.0/24"
    pool: "192.168.1.151 - 192.168.1.199"
    ttl: "0xf0"
    gw: "{{ subnet.gw4 }}"
    dns: "{{ rui_info.ipv4 }},{{ mai_info.ipv4 }}"
    lease_db: "/var/lib/kea/kea-leases4.csv"
  ipv6:
    subnet: "{{ ipv6.ula.prefix }}::/64"
    pool: "{{ ipv6.ula.prefix }}::1000-{{ ipv6.ula.prefix }}::2000"
    lease_db: "/var/lib/kea/kea-leases6.csv"
    option_data:
      - "name": "dns-servers"
        "data": "{{ mai_info.ipv6_addr }}, {{ rui_info.ipv6_addr }}"
        "always-send": true
      - "name": "domain-search"
        "data": "{{ subnet.search | join }}"
        "always-send": true

services_start:
  - dnsmasq
  - rsyslog
  - ssh
  - systemd-journald

firewall:
  policy: deny
  allow_rules:
    - name: "SSH from service line(IPv6)"
      proto: "tcp"
      src: "{{ ipv6.ula.prefix }}::/48"
      port: '22'
    - name: "SSH from service line"
      proto: "tcp"
      src: "192.168.1.0/24"
      port: '22'
    - name: "Zabbix from Zabbix-server"
      proto: "tcp"
      src: "192.168.1.106/24"
      port: "10050"
    - name: "DNS from service line"
      proto: "tcp"
      src: "192.168.1.0/24"
      port: "53"
    - name: "DNS(UDP) from service line"
      proto: "udp"
      src: "192.168.1.0/24"
      port: "53"
    - name: "DHCP from service line"
      proto: "udp"
      src: "any"
      port: "67"
    - name: "DHCP Client from service line"
      proto: "udp"
      src: "any"
      port: "68"
    - name: "DNS from service line(IPv6)"
      proto: "tcp"
      src: "{{ ipv6.ula.prefix }}::/48"
      port: "53"
    - name: "DNS(UDP) from service line(IPv6)"
      proto: "udp"
      src: "{{ ipv6.ula.prefix }}::/48"
      port: "53"
    - name: "Runner Docker ssh"
      proto: "tcp"
      src: "172.17.0.0/16"
      port: "22"
    - name: "Corosync / pcsdport"
      proto: "tcp"
      src: "192.168.1.0/24"
      port: "2224"
    - name: "Corosync / pacemaker"
      proto: "tcp"
      src: "192.168.1.0/24"
      port: "3121"
    - name: "Corosync / pacemaker"
      proto: "tcp"
      src: "192.168.1.0/24"
      port: "3121"
    - name: "Corosync / corosync"
      proto: "udp"
      src: "192.168.1.0/24"
      port: "5404:5412"
    - name: "DHCPv6 from service line"
      proto: "udp"
      src: "::"
      port: "547"
    - name: "DHCPv6 Client from service line"
      proto: "udp"
      src: "::"
      port: "546"
    - name: "Kea DHCP HA heartbeat"
      proto: "tcp"
      src: "192.168.1.0/24"
      port: "8080"
