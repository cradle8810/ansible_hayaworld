---
- name: Play for Proxmox Nodes
  hosts: proxmox
  remote_user: root
  gather_facts: true

  vars_files:
    - host_vars/networks.yml

  handlers:
    - name: Restart handler tasks
      ansible.builtin.import_tasks:
        file: handlers/main.yml

  tasks:
    - name: "Common / Set Hostinfo"
      ansible.builtin.set_fact:
        common_hostinfo: "{{ network | selectattr('ipv4', 'eq', mgmt_ipv4) | first }}"
      vars:
        mgmt_ipv4: "{{ ansible_all_ipv4_addresses | select('match', '192.168.88.') | first }}"
      tags:
        - always

    - name: Proxmox Configurations
      ansible.builtin.import_role:
        name: proxmox
      tags:
        - proxmox

    - name: Put LXC Privilige Container Cheatsheet
      ansible.builtin.copy:
        src: templates/proxmox/root/lxc_docker.txt
        dest: /root/lxc_docker.txt
        owner: root
        group: root
        mode: '0644'

    - name: "Memory Configurations"
      tags:
        - memory
      block:
        - name: KSM Service Settings
          ansible.builtin.import_tasks:
            file: tasks/proxmox/ksm.yml
          tags:
            - ksm

        - name: Install/Config Zramswap
          ansible.builtin.import_tasks:
            file: tasks/zram.yml
          tags:
            - zram
            - swap

        - name: Set Swappiness
          ansible.builtin.import_tasks:
            file: tasks/proxmox/swappiness.yml
          tags:
            - swap

    - name: "Mount tmpfs for /var/tmp"
      ansible.posix.mount:
        src: "tmpfs"
        path: "{{ item }}"
        opts: "defaults"
        fstype: tmpfs
        state: mounted
      loop:
        - "/var/tmp"
      tags:
        - mount

    - name: Set CPU configurations
      ansible.builtin.import_role:
        name: cpufreq
      vars:
        cpufreq_cpu: "{{ cpu }}"
      tags:
        - cpu

    - name: WoL Service Settings
      ansible.builtin.import_tasks:
        file: tasks/proxmox/wol.yml
      vars:
        macaddr: "{{ common_hostinfo.macaddress }}"
      tags:
        - wol
        - network

    - name: "Install corosync-qdevice"
      ansible.builtin.apt:
        name: "corosync-qdevice"
        state: present
        update_cache: true
        cache_valid_time: "{{ apt_cache_valid_time }}"
      tags:
        - corosync
        - qdevice

    - name: "Configure Rsyslog"
      ansible.builtin.import_role:
        name: rsyslog_client
      vars:
        rsyslog_client_config_owner: root
        rsyslog_client_config_group: root
        rsyslog_client_additional_actions: "{{ rsyslog.rsyslog_client_additional_actions }}"
        rsyslog_client_journald_persistent: false
      tags:
        - rsyslog

    - name: "Ignore Powerbutton to shutdown host"
      community.general.ini_file:
        path: "/etc/systemd/logind.conf"
        section: "Login"
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        state: present
        no_extra_spaces: true
        mode: "644"
      loop:
        - option: HandlePowerKey
          value: ignore
        - option: HandlePowerKeyLongPress
          value: poweroff
      notify:
        - "Restart systemd-logind"
      tags:
        - powerbutton

    - name: "APC UPS Settings"
      ansible.builtin.import_role:
        name: apcupsd
      vars:
        apcupsd_role: slave
        apcupsd_timeout: 100
        apcupsd_proxmox: true
      tags:
        - apc
        - ups

    - name: Scrutiny collector setting
      ansible.builtin.import_role:
        name: scrutiny_collector
      vars:
        scrutiny_collector_server_id: "{{ common_hostinfo.shortname }}"
        scrutiny_collector_cron: true
        scrutiny_collector_device:
          devices:
            - device: /dev/sda
              type: 'sat'
            - device: /dev/sdb
              type: 'sat'
      tags:
        - scrutiny

    - name: "Set crontab for sync every 3min"
      ansible.builtin.cron:
        name: "Sync every 3min"
        minute: "*/3"
        job: "/usr/bin/sync > /dev/null 2>&1"
        cron_file: sync-everymin
        user: root
      notify: "Restart cron"
      tags:
        - sync

    - name: Zabbix Agent Config
      ansible.builtin.import_tasks:
        file: tasks/proxmox/zabbix-agent2.yml
      tags:
        - zabbix

    - name: "ISCSI writting throttling"
      ansible.builtin.import_tasks:
        file: tasks/proxmox/iscsi.yml
      tags:
        - iscsi
