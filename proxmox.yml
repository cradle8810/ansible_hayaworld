---
- name: Play for Proxmox Nodes
  hosts: proxmox
  remote_user: root
  gather_facts: true

  vars_files:
    - host_vars/networks.yml

  handlers:
    - name: Restart handler tasks
      ansible.builtin.import_tasks:
        file: handlers/main.yml

  tasks:
    - name: "Common / Set Hostinfo"
      ansible.builtin.set_fact:
        common_hostinfo: "{{ network | selectattr('ipv4', 'eq', mgmt_ipv4) | first }}"
      vars:
        mgmt_ipv4: "{{ ansible_all_ipv4_addresses | select('match', '192.168.88.') | first }}"
      tags:
        - always

    - name: Put LXC Privilige Container Cheatsheet
      ansible.builtin.copy:
        src: templates/proxmox/root/lxc_docker.txt
        dest: /root/lxc_docker.txt
        owner: root
        group: root
        mode: '0644'

    - name: I915 Driver Install
      ansible.builtin.import_tasks:
        file: tasks/proxmox/igpu_driver_install.yml
      tags:
        - igpu

    - name: "Memory Configurations"
      tags:
        - memory
      block:
        - name: KSM Service Settings
          ansible.builtin.import_tasks:
            file: tasks/proxmox/ksm.yml
          tags:
            - ksm

        - name: Install/Config Zramswap
          ansible.builtin.import_tasks:
            file: tasks/zram.yml
          tags:
            - zram
            - swap

        - name: Set Swappiness
          ansible.builtin.import_tasks:
            file: tasks/proxmox/swappiness.yml
          tags:
            - swap

    - name: "Mount tmpfs for /var/tmp"
      ansible.posix.mount:
        src: "tmpfs"
        path: "{{ item }}"
        opts: "defaults"
        fstype: tmpfs
        state: mounted
      loop:
        - "/var/tmp"
      tags:
        - mount

    - name: Set CPU configurations
      ansible.builtin.import_role:
        name: cpufreq
      vars:
        cpufreq_cpu: "{{ cpu }}"
      tags:
        - cpu

    - name: WoL Service Settings
      ansible.builtin.import_tasks:
        file: tasks/proxmox/wol.yml
      vars:
        macaddr: "{{ common_hostinfo.macaddress }}"
      tags:
        - wol
        - network

    - name: "Install corosync-qdevice"
      ansible.builtin.apt:
        name: "corosync-qdevice"
        state: present
        update_cache: true
        cache_valid_time: "{{ apt_cache_valid_time }}"
      tags:
        - corosync
        - qdevice

    - name: "Configure Rsyslog"
      ansible.builtin.import_role:
        name: rsyslog_client
      vars:
        rsyslog_client_config_owner: root
        rsyslog_client_config_group: root
      tags:
        - rsyslog

    - name: "APC UPS Settings"
      ansible.builtin.import_role:
        name: apcupsd
      vars:
        apcupsd_role: slave
        apcupsd_timeout: 100
        apcupsd_proxmox: true
      tags:
        - apc
        - ups
